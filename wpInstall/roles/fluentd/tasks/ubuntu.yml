- name: Set the right timezone
  ansible.builtin.shell: "sudo timedatectl set-timezone Europe/Warsaw"

- name: Install build-essential
  ansible.builtin.package:
    name: "build-essential"
  when: "not 'build-essential' in ansible_facts.ohai_packages"

- name: Install ruby
  ansible.builtin.package:
    name: "ruby-dev"
  when: "not 'ruby-dev' in ansible_facts.ohai_packages"

- name: Check if fluentd is installed
  ansible.builtin.shell:
    cmd: "gem list luentd"
  register: fluentd

- name: Install fluentd
  ansible.builtin.shell:
    cmd: "gem install fluentd --no-doc"
  when: "fluentd.stdout == ''"

- name: Check if fluent-plugin is installed
  ansible.builtin.shell:
    cmd: "gem list fluent-plugin-prometheus"
  register: fluent

- name: Install fluentd plugins
  ansible.builtin.shell:
    cmd: "gem install fluent-plugin-prometheus"
  when: "fluent.stdout == ''"

- name: Create a directory for fluentd
  ansible.builtin.file:
    path: /etc/fluent
    state: directory
    owner: nginx
    group: nginx

- name: Create a file for fluentd
  ansible.builtin.file:
    path: /tmp/fluent_nginx.pos
    state: touch
    owner: nginx
    group: nginx

- name: Create config file for fluentd
  ansible.builtin.template:
    src: fluent.conf.j2
    dest: /etc/fluent/fluent.conf

- name: Create daemon for fluentd
  ansible.builtin.template:
    src: fluentd.service.j2
    dest: /etc/systemd/system/fluentd.service

- name: Include handlers
  ansible.builtin.include_tasks:
    file: roles/fluentd/handlers/main.yml


# 192.168.50.1 - - [14/Nov/2023:11:00:03 +0000] "GET / HTTP/1.1" 200 17690 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/119.0" "0.071" "US" "United States" "NA" 
# 192.168.50.2 - - [14/Nov/2023:11:00:03 +0000] "GET / HTTP/1.1" 200 17690 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/119.0" "0.072" "US" "United States" "NA" 
# 192.168.50.3 - - [14/Nov/2023:11:00:03 +0000] "GET / HTTP/1.1" 200 17690 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/119.0" "0.077" "US" "United States" "NA" 
# 192.168.50.4 - - [14/Nov/2023:11:00:03 +0000] "GET / HTTP/1.1" 200 17690 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/119.0" "0.068" "US" "United States" "NA" 
# 192.168.50.5 - - [14/Nov/2023:11:00:03 +0000] "GET / HTTP/1.1" 200 17690 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/119.0" "0.071" "US" "United States" "NA" 
# 192.168.50.6 - - [14/Nov/2023:11:00:03 +0000] "GET / HTTP/1.1" 200 17690 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/119.0" "0.069" "US" "United States" "NA" 
# 192.168.50.7 - - [14/Nov/2023:11:00:03 +0000] "GET / HTTP/1.1" 200 17690 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/119.0" "0.071" "PL" "Poland" "EU" 
# 192.168.50.7 - - [14/Nov/2023:11:00:03 +0000] "GET / HTTP/1.1" 200 17690 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/119.0" "0.072" "PL" "Poland" "EU" 
# 192.168.50.8 - - [14/Nov/2023:11:00:03 +0000] "GET / HTTP/1.1" 200 17690 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/119.0" "0.077" "PL" "Poland" "EU" 
# 192.168.50.3 - - [14/Nov/2023:11:00:03 +0000] "GET / HTTP/1.1" 200 17690 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/119.0" "0.068" "PL" "Poland" "EU" 
# 192.168.50.2 - - [14/Nov/2023:11:00:03 +0000] "GET / HTTP/1.1" 200 17690 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/119.0" "0.071" "GR" "Germany" "EU" 
# 192.168.50.7 - - [14/Nov/2023:11:00:03 +0000] "GET / HTTP/1.1" 200 17690 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/119.0" "0.069" "ROM" "Romania" "EU" 